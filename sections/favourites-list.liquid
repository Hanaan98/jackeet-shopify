<script type="module" src="{{ 'wishlist.js' | asset_url }}"></script>

<div class="favourites-page section section--full-width-margin color-{{ section.settings.color_scheme }}">
  <div class="favourites-container spacing-style">
    <div id="favourites-empty-state" class="favourites-empty" style="display: none;">
      <div class="favourites-empty__content">
        <svg class="favourites-empty__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h2 class="favourites-empty__title h3">{{ section.settings.empty_title }}</h2>
        <p class="favourites-empty__text">{{ section.settings.empty_text }}</p>
        <a href="{{ section.settings.empty_button_link }}" class="button button-primary">
          {{ section.settings.empty_button_text }}
        </a>
      </div>
    </div>

    <div id="favourites-loading" class="favourites-loading">
      <div class="favourites-loading__spinner"></div>
    </div>

    <div id="favourites-grid" class="favourites-grid" style="display: none;">
      <!-- Products will be loaded here via JavaScript -->
    </div>
  </div>
</div>

<script>
  (async function() {
    const { getWishlist, clearWishlist } = await import('{{ 'wishlist.js' | asset_url }}');
    
    const emptyState = document.getElementById('favourites-empty-state');
    const loading = document.getElementById('favourites-loading');
    const grid = document.getElementById('favourites-grid');
    
    const wishlist = getWishlist();
    
    console.log('[Favourites] Current wishlist:', wishlist);
    
    // Check if all items are in old format (just numbers)
    const hasOldFormat = wishlist.some(item => typeof item === 'number');
    const hasNewFormat = wishlist.some(item => typeof item === 'object');
    
    if (hasOldFormat && !hasNewFormat) {
      console.log('[Favourites] Detected old wishlist format, clearing...');
      clearWishlist();
      loading.style.display = 'none';
      emptyState.style.display = 'block';
      
      const helpText = document.createElement('p');
      helpText.style.marginTop = '1rem';
      helpText.style.fontSize = '0.875rem';
      helpText.style.color = 'var(--color-foreground-secondary)';
      helpText.textContent = 'Your wishlist was cleared due to an update. Please add your favorite products again.';
      emptyState.querySelector('.favourites-empty__content').appendChild(helpText);
      return;
    }
    
    if (wishlist.length === 0) {
      loading.style.display = 'none';
      emptyState.style.display = 'block';
      return;
    }
    
    // Fetch product data
    try {
      const productPromises = wishlist.map(async (item) => {
        // Support both old format (just ID) and new format (object with handle)
        const handle = typeof item === 'object' && item.handle ? item.handle : null;
        const productId = typeof item === 'object' ? item.id : item;
        
        if (!handle) {
          console.warn('[Favourites] Old format detected - product ID without handle:', productId);
          console.log('[Favourites] Please re-add this product to wishlist to store the handle');
          return null;
        }
        
        console.log('[Favourites] Fetching product:', handle);
        const response = await fetch(`/products/${handle}.js`);
        if (!response.ok) {
          console.error('[Favourites] Failed to fetch product:', handle, response.status);
          return null;
        }
        return response.json();
      });
      
      const products = (await Promise.all(productPromises)).filter(p => p !== null);
      
      console.log('[Favourites] Loaded products:', products.length);
      
      if (products.length === 0) {
        loading.style.display = 'none';
        emptyState.style.display = 'block';
        
        // Show helpful message if old format detected
        if (wishlist.length > 0 && wishlist.some(item => typeof item === 'number')) {
          const helpText = document.createElement('p');
          helpText.style.marginTop = '1rem';
          helpText.style.fontSize = '0.875rem';
          helpText.style.color = 'var(--color-foreground-secondary)';
          helpText.textContent = 'Please re-add your favorite products to update the wishlist.';
          emptyState.querySelector('.favourites-empty__content').appendChild(helpText);
        }
        return;
      }
      
      // Render products
      loading.style.display = 'none';
      grid.style.display = 'grid';
      
      products.forEach((product) => {
        const card = createProductCard(product);
        grid.appendChild(card);
      });
      
    } catch (error) {
      console.error('Error loading favourites:', error);
      loading.style.display = 'none';
      emptyState.style.display = 'block';
    }
    
    function createProductCard(product) {
      const card = document.createElement('div');
      card.className = 'favourites-product-card';
      
      const variant = product.variants[0];
      const image = product.featured_image || (product.images && product.images[0]);
      const price = formatMoney(variant.price);
      const comparePrice = variant.compare_at_price ? formatMoney(variant.compare_at_price) : null;
      
      card.innerHTML = `
        <div class="favourites-product-card__inner">
          <a href="/products/${product.handle}" class="favourites-product-card__link">
            ${image ? `
              <div class="favourites-product-card__image-wrapper">
                <img 
                  src="${image}" 
                  alt="${product.title}"
                  class="favourites-product-card__image"
                  loading="lazy"
                />
              </div>
            ` : ''}
            <div class="favourites-product-card__info">
              <h3 class="favourites-product-card__title">${product.title}</h3>
              <div class="favourites-product-card__price">
                ${comparePrice ? `<span class="favourites-product-card__compare-price">${comparePrice}</span>` : ''}
                <span class="favourites-product-card__current-price">${price}</span>
              </div>
            </div>
          </a>
          <button 
            class="favourites-product-card__remove" 
            data-product-id="${product.id}"
            aria-label="Remove from favourites"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
              <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      `;
      
      // Add remove handler
      const removeBtn = card.querySelector('.favourites-product-card__remove');
      removeBtn.addEventListener('click', async () => {
        const { removeFromWishlist } = await import('{{ 'wishlist.js' | asset_url }}');
        removeFromWishlist(product.id);
        card.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
          card.remove();
          const remainingCards = grid.querySelectorAll('.favourites-product-card');
          if (remainingCards.length === 0) {
            grid.style.display = 'none';
            emptyState.style.display = 'block';
          }
        }, 300);
      });
      
      return card;
    }
    
    function formatMoney(cents) {
      const amount = cents / 100;
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: '{{ cart.currency.iso_code }}'
      }).format(amount);
    }
  })();
</script>

{% stylesheet %}
  .favourites-page {
    padding-block: var(--padding-lg);
    min-height: 60vh;
  }

  @media screen and (min-width: 750px) {
    .favourites-page {
      padding-block: var(--padding-2xl);
    }
  }

  .favourites-container {
    max-width: var(--page-width);
    margin: 0 auto;
    padding-inline: var(--padding-md);
  }

  @media screen and (min-width: 750px) {
    .favourites-container {
      padding-inline: var(--padding-lg);
    }
  }

  .favourites-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 50vh;
    text-align: center;
  }

  .favourites-empty__content {
    max-width: 500px;
  }

  .favourites-empty__icon {
    width: 60px;
    height: 60px;
    color: rgb(var(--color-foreground-rgb) / 0.3);
    margin: 0 auto var(--margin-md);
  }

  @media screen and (min-width: 750px) {
    .favourites-empty__icon {
      width: 80px;
      height: 80px;
      margin: 0 auto var(--margin-lg);
    }
  }

  .favourites-empty__title {
    margin-bottom: var(--margin-xs);
    font-size: var(--font-size--lg);
  }

  @media screen and (min-width: 750px) {
    .favourites-empty__title {
      margin-bottom: var(--margin-sm);
    }
  }

  .favourites-empty__text {
    color: rgb(var(--color-foreground-rgb) / 0.7);
    margin-bottom: var(--margin-lg);
    font-size: var(--font-size--sm);
  }

  @media screen and (min-width: 750px) {
    .favourites-empty__text {
      margin-bottom: var(--margin-xl);
      font-size: var(--font-size--md);
    }
  }

  .favourites-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 50vh;
  }

  .favourites-loading__spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgb(var(--color-foreground-rgb) / 0.2);
    border-top-color: var(--color-foreground);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .favourites-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--gap-xl);
    margin-top: var(--margin-xl);
  }

  @media screen and (max-width: 749px) {
    .favourites-grid {
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: var(--gap-md);
    }
  }

  .favourites-product-card {
    position: relative;
  }

  .favourites-product-card__inner {
    position: relative;
    background: var(--color-background);
    border: 1px solid rgb(var(--color-border-rgb) / 0.2);
    border-radius: var(--style-border-radius-cards);
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .favourites-product-card__inner:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgb(var(--color-shadow-rgb) / 0.15);
  }

  .favourites-product-card__link {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .favourites-product-card__image-wrapper {
    position: relative;
    padding-bottom: 125%;
    background: rgb(var(--color-foreground-rgb) / 0.05);
  }

  .favourites-product-card__image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .favourites-product-card__info {
    padding: var(--padding-sm);
  }

  @media screen and (min-width: 750px) {
    .favourites-product-card__info {
      padding: var(--padding-md);
    }
  }

  .favourites-product-card__title {
    font-size: var(--font-size--sm);
    font-weight: 500;
    margin: 0 0 var(--margin-xs);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @media screen and (min-width: 750px) {
    .favourites-product-card__title {
      font-size: var(--font-size--md);
    }
  }

  .favourites-product-card__price {
    display: flex;
    align-items: center;
    gap: var(--gap-xs);
    font-size: 12px;
  }

  @media screen and (min-width: 750px) {
    .favourites-product-card__price {
      font-size: var(--font-size--sm);
    }
  }

  .favourites-product-card__compare-price {
    text-decoration: line-through;
    color: rgb(var(--color-foreground-rgb) / 0.5);
  }

  .favourites-product-card__current-price {
    font-weight: 600;
  }

  .favourites-product-card__remove {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 32px;
    height: 32px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.08);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    backdrop-filter: blur(8px);
    z-index: 2;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  @media screen and (min-width: 750px) {
    .favourites-product-card__remove {
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
    }
  }

  .favourites-product-card__remove:hover {
    background: rgba(220, 38, 38, 0.1);
    transform: scale(1.1);
  }

  .favourites-product-card__remove svg {
    width: 14px;
    height: 14px;
    color: var(--color-foreground);
  }

  @media screen and (min-width: 750px) {
    .favourites-product-card__remove svg {
      width: 16px;
      height: 16px;
    }
  }

  @keyframes fadeOut {
    to {
      opacity: 0;
      transform: scale(0.9);
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Favourites List",
  "settings": [
    {
      "type": "select",
      "id": "color_scheme",
      "label": "Color scheme",
      "options": [
        {
          "value": "scheme-1",
          "label": "Scheme 1"
        },
        {
          "value": "scheme-2",
          "label": "Scheme 2"
        },
        {
          "value": "scheme-3",
          "label": "Scheme 3"
        }
      ],
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Empty State"
    },
    {
      "type": "text",
      "id": "empty_title",
      "label": "Title",
      "default": "Your wishlist is empty"
    },
    {
      "type": "textarea",
      "id": "empty_text",
      "label": "Text",
      "default": "Start adding your favourite items by clicking the heart icon on any product."
    },
    {
      "type": "text",
      "id": "empty_button_text",
      "label": "Button text",
      "default": "Start Shopping"
    },
    {
      "type": "url",
      "id": "empty_button_link",
      "label": "Button link",
      "default": "/collections/all"
    }
  ],
  "presets": [
    {
      "name": "Favourites List"
    }
  ]
}
{% endschema %}
